# QCS Cargo 2.0 - Staging Configuration (Direct IP Access)
# Use this for testing before domain/Traefik setup

networks:
  qcs_network:
    driver: bridge

services:
  qcs_pocketbase:
    build:
      context: ./pocketbase
      dockerfile: Dockerfile
    container_name: qcs_pocketbase
    restart: unless-stopped
    command: ["./pocketbase", "serve", "--http=0.0.0.0:8090", "--dir=/pb_data"]
    environment:
      - PB_DATA_DIR=/pb_data
      - PB_ENCRYPTION_KEY=${PB_ENCRYPTION_KEY}
      - RESEND_API_KEY=${RESEND_API_KEY}
      - RESEND_FROM_EMAIL=${RESEND_FROM_EMAIL:-QCS Cargo <noreply@qcs-cargo.com>}
      - FRONTEND_URL=${FRONTEND_URL}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
    volumes:
      - ../files/qcs_pb_data:/pb_data
      - ./pocketbase/pb_migrations:/pb_migrations
      - ./pocketbase/pb_hooks:/pb_hooks
    ports:
      - "8091:8090"
    networks:
      - qcs_network
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://127.0.0.1:8090/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    mem_limit: 512m
    cpus: 1.0

  qcs_web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PUBLIC_POCKETBASE_URL: ${PUBLIC_POCKETBASE_URL:-http://82.25.85.157:8091}
        PUBLIC_SITE_URL: ${PUBLIC_SITE_URL:-http://82.25.85.157:3001}
        PUBLIC_COMPANY_NAME: QCS Cargo
        PUBLIC_COMPANY_PHONE: "201-249-0929"
        PUBLIC_COMPANY_EMAIL: sales@qcs-cargo.com
        PUBLIC_COMPANY_ADDRESS: 35 Obrien St E12 Kearny NJ 07032
        KINDE_ISSUER_URL: ${KINDE_ISSUER_URL:-https://qcsinc.kinde.com}
        KINDE_CLIENT_ID: ${KINDE_CLIENT_ID}
        KINDE_CLIENT_SECRET: ${KINDE_CLIENT_SECRET}
        KINDE_REDIRECT_URL: ${KINDE_REDIRECT_URL:-http://82.25.85.157:3001/api/auth/kinde_callback}
        KINDE_POST_LOGOUT_REDIRECT_URL: ${KINDE_POST_LOGOUT_REDIRECT_URL:-http://82.25.85.157:3001}
        KINDE_POST_LOGIN_REDIRECT_URL: ${KINDE_POST_LOGIN_REDIRECT_URL:-http://82.25.85.157:3001/dashboard}
    container_name: qcs_web
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      # Email Configuration
      - RESEND_API_KEY=${RESEND_API_KEY}
      - RESEND_FROM_EMAIL=${RESEND_FROM_EMAIL:-QCS Cargo <noreply@qcs-cargo.com>}
      - FROM_EMAIL=${FROM_EMAIL:-noreply@qcs-cargo.com}
      - REPLY_TO_EMAIL=${REPLY_TO_EMAIL:-support@qcs-cargo.com}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-support@qcs-cargo.com}
      # URLs
      - PUBLIC_POCKETBASE_URL=${PUBLIC_POCKETBASE_URL:-http://82.25.85.157:8091}
      - PUBLIC_SITE_URL=${PUBLIC_SITE_URL:-http://82.25.85.157:3001}
      - FRONTEND_URL=${FRONTEND_URL:-http://82.25.85.157:3001}
      # Kinde Auth
      - KINDE_ISSUER_URL=${KINDE_ISSUER_URL:-https://qcsinc.kinde.com}
      - KINDE_CLIENT_ID=${KINDE_CLIENT_ID}
      - KINDE_CLIENT_SECRET=${KINDE_CLIENT_SECRET}
      - KINDE_REDIRECT_URL=${KINDE_REDIRECT_URL:-http://82.25.85.157:3001/api/auth/kinde_callback}
      - KINDE_POST_LOGOUT_REDIRECT_URL=${KINDE_POST_LOGOUT_REDIRECT_URL:-http://82.25.85.157:3001}
      - KINDE_POST_LOGIN_REDIRECT_URL=${KINDE_POST_LOGIN_REDIRECT_URL:-http://82.25.85.157:3001/dashboard}
      - KINDE_SCOPE=${KINDE_SCOPE:-profile email offline openid}
    depends_on:
      qcs_pocketbase:
        condition: service_healthy
    ports:
      - "3001:3000"
    networks:
      - qcs_network
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://127.0.0.1:3000/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    mem_limit: 512m
    cpus: 1.0


