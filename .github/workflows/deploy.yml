name: CI/CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  check:
    name: Type Check & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - run: npm ci

      - name: Svelte type check
        run: npm run check

      - name: Lint
        run: npm run lint -- --quiet

  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - run: npm ci

      - name: Run unit tests
        run: npm run test:unit

  build-verify:
    name: Build Verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - run: npm ci

      - name: Production build
        run: npm run build
        env:
          PUBLIC_POCKETBASE_URL: https://api.qcs-cargo.com
          PUBLIC_SITE_URL: https://qcs-cargo.com
          PUBLIC_STRIPE_KEY: pk_placeholder

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [check, unit-test, build-verify]
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          command_timeout: 20m
          script: |
            set -e
            echo "=== Pulling latest code ==="
            cd /root/qcs-cargo-v2
            git pull origin main

            echo "=== Building Docker images ==="
            docker compose -f docker-compose.prod.yml build --no-cache

            echo "=== Restarting services ==="
            docker compose -f docker-compose.prod.yml up -d

            echo "=== Waiting for services to become healthy ==="
            sleep 15

            for i in 1 2 3 4 5 6; do
              WEB_STATUS=$(docker inspect --format='{{.State.Health.Status}}' qcs_web 2>/dev/null || echo "unknown")
              PB_STATUS=$(docker inspect --format='{{.State.Health.Status}}' qcs_pocketbase 2>/dev/null || echo "unknown")
              echo "  Attempt $i â€” web: $WEB_STATUS, pocketbase: $PB_STATUS"
              if [ "$PB_STATUS" = "healthy" ] && [ "$WEB_STATUS" = "healthy" ]; then
                break
              fi
              sleep 10
            done

            echo "=== Health check endpoints ==="
            curl -sf --max-time 10 https://api.qcs-cargo.com/api/health || { echo "FAIL: PocketBase health check"; exit 1; }
            echo " PocketBase OK"
            curl -sf --max-time 10 https://qcs-cargo.com/api/health || { echo "FAIL: Web health check"; exit 1; }
            echo " Web OK"

            echo "=== Deployment complete ==="
            docker ps --format 'table {{.Names}}\t{{.Status}}' | grep qcs
